name: Deploy to Firebase Hosting on PR
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository && github.event.action != 'closed' }}
    runs-on: ubuntu-latest
    environment: hConnect
    env:
      PUBLIC_FIREBASE_API_KEY: ${{ secrets.PUBLIC_FIREBASE_API_KEY }}
      PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.PUBLIC_FIREBASE_AUTH_DOMAIN }}
      PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.PUBLIC_FIREBASE_PROJECT_ID }}
      PUBLIC_FIREBASE_APP_ID: ${{ secrets.PUBLIC_FIREBASE_APP_ID }}
      PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
      PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.PUBLIC_FIREBASE_STORAGE_BUCKET }}
      PUBLIC_FIREBASE_STORAGE_BUCKET_URL: ${{ secrets.PUBLIC_FIREBASE_STORAGE_BUCKET_URL }}
      PUBLIC_TENOR_API_KEY: ${{ secrets.PUBLIC_TENOR_API_KEY }}
      PUBLIC_FCM_VAPID_KEY: ${{ secrets.PUBLIC_FCM_VAPID_KEY }}
      PUBLIC_TURN_URLS: ${{ secrets.PUBLIC_TURN_URLS }}
      PUBLIC_TURN_USERNAME: ${{ secrets.PUBLIC_TURN_USERNAME }}
      PUBLIC_TURN_CREDENTIAL: ${{ secrets.PUBLIC_TURN_CREDENTIAL }}
      PUBLIC_ENABLE_TURN_FALLBACK: ${{ secrets.PUBLIC_ENABLE_TURN_FALLBACK }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Deploy preview
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_HCONNECT_6212B }}
          projectId: hconnect-6212b

  cleanup_preview_channel:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository && github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    environment: hConnect
    env:
      CHANNEL_ID: pr${{ github.event.pull_request.number }}
      PROJECT_ID: hconnect-6212b
    steps:
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_HCONNECT_6212B }}

      - name: Ensure Node is available
        uses: actions/setup-node@v4
        with:
            node-version: 22

      - name: Delete Firebase preview channel
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking for preview channel ${CHANNEL_ID} in ${PROJECT_ID}"
          CHANNEL_FOUND="$(npx firebase-tools@latest hosting:channel:list --project "${PROJECT_ID}" --limit 200 --json | jq -er --arg CHANNEL_ID "${CHANNEL_ID}" '.result[] | select(.channelId == $CHANNEL_ID) | .channelId' || true)"

          if [[ -z "${CHANNEL_FOUND}" ]]; then
            echo "Channel ${CHANNEL_ID} already removed or expired."
            exit 0
          fi

          echo "Deleting channel ${CHANNEL_ID} to free Firebase Hosting preview quota."
          npx firebase-tools@latest hosting:channel:delete "${CHANNEL_ID}" --project "${PROJECT_ID}" --force
